// script.js (module)
const QUESTIONS = [
"1. Вам тяжело видеть, что кто-то страдает?",
"2. Вы сопереживаете людям, когда они рассказывают о своих проблемах?",
"3. Вас легко трогают истории из жизни других людей?",
"4. Вы стараетесь помогать людям, даже если это для вас неудобно?",
"5. Вам трудно оставаться равнодушным к несправедливости?",
"6. Вы часто замечаете изменения настроения у окружающих?",
"7. Вы искренне радуетесь успехам друзей так же, как собственным?",
"8. Вас радует, когда другие люди счастливы?",
"9. Вы обычно замечаете мелкие изменения в поведении других людей?",
"10. Считаете ли вы себя чутким человеком?",
"11. Как вы реагируете, если близкий человек скрывает свои чувства?",
"12. Как вы помогаете друзьям или коллегам, когда они в трудной ситуации?",
"13. Оцените по шкале 1–5: «Мне легко понять настроение других людей».",
"14. Как вы справляетесь с чужой агрессией или раздражением?",
"15. Вы чувствуете эмоциональную нагрузку, когда кто-то рядом переживает стресс?",
"16. Вам сложно абстрагироваться от чужих проблем, чтобы сосредоточиться на себе?",
"17. Оцените: «Я могу сохранять спокойствие, даже если рядом кто-то сильно переживает».",
"18. Вы часто беспокоитесь о будущем?",
"19. Легко волнуетесь из-за мелочей?",
"20. Вас тревожат проблемы даже ночью?",
"21. Страх, что вы не справитесь с трудностями, бывает у вас часто?",
"22. Вам трудно успокоиться после конфликта или ссоры?",
"23. Иногда вы думаете, что с вами что-то не так?",
"24. Вас беспокоит мнение окружающих о вас?",
"25. Вам сложно сосредоточиться, когда вы нервничаете?",
"26. Вы часто испытываете необъяснимую тревогу?",
"27. Избегаете ситуаций, вызывающих у вас тревогу?",
"28. Как вы справляетесь с длительным стрессом?",
"29. Оцените: «Я могу контролировать свои эмоции в сложной ситуации».",
"30. Как вы реагируете на критику в учебе или работе?",
"31. Насколько часто стресс мешает вашим действиям?",
"32. Оцените: «Я умею расслабляться после сильного напряжения».",
"33. Вам сложно концентрироваться при эмоциональном напряжении?",
"34. Оцените: «Я могу сохранять продуктивность в условиях давления».",
"35. Вы довольны своими способностями и качествами?",
"36. Вам легко принимать комплименты?",
"37. Вы чувствуете, что заслуживаете уважения окружающих?",
"38. Иногда вы думаете, что другие люди лучше вас?",
"39. Вы часто критикуете себя за незначительные ошибки?",
"40. Вы уверены в себе при знакомстве с новыми людьми?",
"41. Считаете, что заслуживаете быть счастливым?",
"42. Вам сложно мириться с личными неудачами?",
"43. Можете признать свои достижения и гордиться ими?",
"44. Вы часто сомневаетесь в своих решениях?",
"45. Как вы реагируете на публичное внимание или похвалу?",
"46. Оцените: «Я умею принимать свои ошибки без сильного самоосуждения».",
"47. Насколько легко вам доверять себе в принятии решений?",
"48. Оцените: «Я способен мотивировать себя для выполнения сложных задач».",
"49. Вы считаете себя способным справиться с жизненными трудностями?",
"50. Оцените: «Я могу сохранять позитивное отношение к себе, даже если что-то не получается».",
"51. Вы позволяете себе отдых и заботу о себе без чувства вины?",
"52. Вы легко открываетесь людям и доверяете им?",
"53. Считаете, что большинству людей можно доверять?",
"54. Вас часто обманывали, и вам теперь трудно доверять людям?",
"55. Вам тяжело заводить новых друзей?",
"56. Вам приятно делиться своими проблемами с близкими людьми?",
"57. Чувствуете себя одиноко, даже когда рядом другие люди?",
"58. Вы скучаете по близким, когда они далеко?",
"59. Вы долго обижаетесь на тех, кто вас подвёл?",
"60. Вам комфортнее быть одному, чем в шумной компании?",
"61. Вам нравится находиться в компании людей?",
"62. Вы предпочитаете планировать и работать в одиночку?",
"63. Часто берёте инициативу в работе в группе?",
"64. Чувствуете себя комфортно в незнакомой компании?",
"65. Оцените: «Мне легко поддерживать дружеские отношения».",
"66. Вы легко заводите новые контакты на учебе или работе?",
"67. Оцените: «Я могу доверять людям, даже если они мало знакомы».",
"68. Как вы ведете себя в группе, когда возникают конфликты?",
"69. Вы стараетесь быть честным, даже когда можно солгать?",
"70. Иногда вы намекаете людям, что нужна их помощь?",
"71. Вы считаете важным выполнять обещанное?",
"72. Оцените: «Мне неприятно использовать других для своей выгоды».",
"73. Вы готовы помогать тем, кто в трудной ситуации?",
"74. Вас раздражает неправильное поведение окружающих?",
"75. Вам трудно принять, когда кто-то ведёт себя некрасиво?",
"76. Вы следуете своим моральным принципам, даже если это неудобно?",
"77. Оцените: «Я стараюсь поступать справедливо, даже если это противоречит личной выгоде».",
"78. Как вы поступаете, если видите, что кто-то нарушает правила ради выгоды?",
"79. Вы способны признать чужие заслуги без зависти?",
"80. Оцените: «Я стараюсь учиться на своих ошибках и ошибках других».",
"81. Вам важно помогать семье и близким?",
"82. Оцените: «Я могу принимать последствия своих решений, даже если они неприятны».",
"83. Насколько для вас важно соблюдать свои обещания в работе или учебе?",
"84. Как вы реагируете на несправедливое отношение к себе?",
"85. Оцените: «Я стараюсь развивать свои моральные качества постоянно».",
"86. Иногда вы меняете своё мнение, чтобы угодить другим?",
"87. Вы умеете убеждать людей принять вашу точку зрения?",
"88. Вы замечаете, когда люди пытаются манипулировать вами?",
"89. Вы стараетесь понять мотивацию поступков других людей?",
"90. Вам неприятно, когда люди используют вас?",
"91. Вы легко замечаете попытки скрытой манипуляции?",
"92. Оцените: «Я могу убедительно донести свою позицию в группе».",
"93. Как вы действуете, если кто-то пытается манипулировать вами?",
"94. Вы способны использовать свои навыки убеждения для добрых целей?",
"95. Оцените: «Я анализирую чужие поступки, чтобы понять их мотивы».",
"96. Вы замечаете, когда окружающие пытаются вызвать у вас чувство вины?",
"97. Оцените: «Я умею отстаивать свои интересы, не причиняя вреда другим».",
"98. Как вы реагируете на давление со стороны группы?",
"99. Вы понимаете, когда кто-то пытается манипулировать эмоциями?",
"100. Оцените: «Мне важно сохранять честность, даже если могу потерять влияние».",
"101. Вы часто обдумываете последствия своих слов и действий на других?",
"102. Оцените: «Я могу замечать скрытые намерения людей».",
"103. Вы легко решаете новые задачи, если нет готового решения?",
"104. Оцените: «Мне легко находить креативные решения в сложных ситуациях».",
"105. Вы анализируете события, чтобы избежать ошибок в будущем?",
"106. Как вы действуете, если сталкиваетесь с проблемой, которой ранее не было?",
"107. Вы способны логически обосновать своё решение?",
"108. Оцените: «Я могу работать с информацией под давлением времени».",
"109. Вы умеете структурировать свои мысли перед принятием решения?",
"110. Как вы принимаете решения, когда есть противоречивые данные?",
"111. Оцените: «Я могу переключаться между задачами без потери качества работы».",
"112. Насколько быстро вы усваиваете новую информацию?",
"113. Вы склонны проверять факты, прежде чем принимать решение?",
"114. Оцените: «Я могу планировать действия на несколько шагов вперёд».",
"115. Как вы решаете сложные задачи, когда есть риск ошибки?",
"116. Вы можете находить альтернативные подходы, если первый не сработал?",
"117. Оцените: «Я умею критически анализировать свои решения».",
"118. Насколько для вас важно обдумывать последствия своих действий?",
"119. Как вы реагируете на непредвиденные трудности?",
"120. Что для вас важнее — признание окружающих или личное удовлетворение?",
"121. Оцените: «Я способен работать над долгосрочной целью, даже если она скучна».",
"122. Вы ставите перед собой конкретные цели и достигаете их?",
"123. Насколько легко вы теряете мотивацию при трудностях?",
"124. Вы стремитесь к постоянному самосовершенствованию?",
"125. Оцените: «Я готов вкладывать усилия в обучение и развитие».",
"126. Насколько для вас важны карьерные или учебные достижения?",
"127. Вы способны жертвовать краткосрочными удовольствиями ради долгосрочных целей?",
"128. Оцените: «Я могу работать над задачей даже без внешней мотивации».",
"129. Как вы определяете свои приоритеты в жизни?",
"130. Вы легко переключаетесь между целями, если появляются новые обстоятельства?",
"131. Оцените: «Я стараюсь планировать будущее с учетом возможных рисков».",
"132. Вы оцениваете свои успехи и прогресс регулярно?",
"133. Насколько важно для вас чувствовать смысл в своих действиях?",
"134. Оцените: «Я могу оставаться мотивированным, даже если результат не виден сразу».",
"135. Вы склонны брать на себя ответственность за достижение личных целей?",
"136. Как вы реагируете на разочарования, мешающие вашим планам?",
"137. Оцените: «Я могу сохранять целеустремленность в сложных ситуациях».",
"138. Как вы реагируете на внезапные изменения в планах?",
"139. Оцените: «Я могу быстро переключаться между задачами без стресса».",
"140. Вы способны сохранять продуктивность при нехватке времени?",
"141. Оцените: «Я легко адаптируюсь к новым условиям».",
"142. Насколько для вас важно поддерживать баланс между работой и отдыхом?",
"143. Как часто усталость влияет на вашу продуктивность?",
"144. Оцените: «Я могу справляться с физическим и умственным напряжением».",
"145. Насколько легко вы восстанавливаетесь после эмоционального истощения?",
"146. Вы способны планировать отдых для восстановления сил?",
"147. Оцените: «Я могу сохранять концентрацию, даже если недосыпаю».",
"148. Как вы реагируете на внезапное давление или стрессовую ситуацию?",
"149. Оцените: «Я могу принимать решения даже в условиях давления».",
"150. Вы способны распределять свои ресурсы (время, силы) рационально?",
"151. Насколько гибко вы меняете стратегии, если текущая не работает?",
"152. Оцените: «Я могу сохранять спокойствие и эффективность в неожиданных ситуациях».",
"153. Как вы действуете, если сталкиваетесь с множеством задач одновременно?",
"154. Насколько вы следите за своим здоровьем для поддержания эффективности?",
"155. Оцените: «Я могу поддерживать продуктивность при физическом или эмоциональном напряжении».",
"156. Как вы справляетесь с длительной усталостью на учебе или работе?",
"157. Вы умеете правильно оценивать свои возможности перед началом задачи?",
"158. Оцените: «Я могу сохранять концентрацию на цели при отвлекающих факторах».",
"159. Вы способны планировать и корректировать действия, если условия меняются?",
"160. Оцените: «Я могу эффективно управлять собой и своими ресурсами в сложных ситуациях»."
];

const container = document.getElementById("questionsContainer");
const form = document.getElementById("testForm");
const resultsEl = document.getElementById("results");
const resultSection = document.getElementById("resultSection");
const downloadArea = document.getElementById("downloadArea");

// Render questions
QUESTIONS.forEach((text, idx) => {
  const div = document.createElement("div");
  div.className = "qCard";
  const label = document.createElement("label");
  label.className = "qTitle";
  label.textContent = `${text}`;
  const ta = document.createElement("textarea");
  ta.name = `q${idx+1}`;
  ta.placeholder = "Напишите ответ своими словами (обязательно)";
  ta.required = true;
  div.appendChild(label);
  div.appendChild(ta);
  container.appendChild(div);
});

// helper to create+click download link
function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const textareas = Array.from(container.querySelectorAll("textarea"));
  const answers = [];
  for (let i = 0; i < textareas.length; i++){
    const v = textareas[i].value.trim();
    if (!v) {
      alert(`Пожалуйста, ответьте на вопрос ${i+1}`);
      textareas[i].focus();
      return;
    }
    answers.push({ question: QUESTIONS[i], answer: v });
  }

  // Save answers.txt (plain)
  const textContent = answers.map(a => `${a.question}\nОтвет: ${a.answer}\n`).join("\n");
  const txtBlob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
  downloadBlob(txtBlob, "answers.txt");

  // show loading
  resultsEl.textContent = "Идёт анализ... Пожалуйста, подождите — это может занять ~10–40 секунд.";
  resultSection.classList.remove("hidden");
  downloadArea.innerHTML = "";

  try {
    const resp = await fetch("/api/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`Сервер вернул ${resp.status}: ${txt}`);
    }

    const data = await resp.json();
    const analysisText = data.analysis || "Анализ не получен.";
    resultsEl.textContent = analysisText;

    if (data.docBase64) {
      const bytes = Uint8Array.from(atob(data.docBase64), c => c.charCodeAt(0));
      const blob = new Blob([bytes.buffer], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "analysis.docx";
      link.textContent = "Скачать результат (Word)";
      downloadArea.appendChild(link);
    } else {
      // fallback: provide analysis as .txt
      const b = new Blob([analysisText], { type: "text/plain;charset=utf-8" });
      downloadBlob(b, "analysis.txt");
    }

  } catch (err) {
    console.error(err);
    resultsEl.textContent = `Ошибка при анализе: ${err.message}`;
  }
});
